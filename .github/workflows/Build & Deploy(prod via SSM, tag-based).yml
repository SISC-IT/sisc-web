name: Build & Deploy (prod via SSM, tag-based)

on:
  push:
    tags:
      - "v*"            # ⬅ v1.0.0 이런 태그 push 시에만 빌드+배포

concurrency:
  group: deploy-prod
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  REPO: sisc-it/sisc-web
  IMAGE_BACK: ghcr.io/sisc-it/sisc-web-back
  AWS_REGION: ap-northeast-2
  TARGET_DIR: /home/ubuntu/apps/sisc-web   # EC2에서 docker-compose 있는 경로
  EC2_TAG_KEY: App
  EC2_TAG_VALUE: sisc-web-prod             # ⬅ 배포 대상 EC2 태그 값
  S3_BUCKET_FRONTEND: sisc-web-frontend-prod        # ⬅ 프론트 S3 버킷 이름 (수정)
  # CLOUDFRONT_DISTRIBUTION_ID는 보안상 env 대신 secrets로 둘게

jobs:
  # -----------------------------
  # 1) 백엔드 Docker 빌드 + GHCR 푸시
  # -----------------------------
  build-back:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Meta (tags/labels) - backend
        id: meta-back
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_BACK }}
          tags: |
            type=ref,event=tag   # ⬅ git 태그 이름으로만 이미지 태깅 (latest 제거)

      - name: Build & Push (backend)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta-back.outputs.tags }}
          labels: ${{ steps.meta-back.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # -----------------------------
  # 2) 프론트: React 빌드 → S3 업로드 → CloudFront 캐시 무효화
  # -----------------------------
  build-front:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write          # AWS OIDC용
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"   # 프로젝트 Node 버전에 맞게 조정

      - name: Install dependencies
        run: |
          npm ci || npm install

      - name: Build frontend
        run: |
          npm run build        # dist/ 또는 build/ 생성 (Vite면 dist)

      - name: Configure AWS credentials (for S3/CloudFront)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload build artifacts to S3
        run: |
          # Vite 기준: dist 폴더. CRA면 build 폴더로 변경
          aws s3 sync ./dist "s3://${{ env.S3_BUCKET_FRONTEND }}" \
            --only-show-errors
          # --delete를 일부러 안 씀: 기존 다른 파일은 놔두고, 동일 경로만 덮어씀

      - name: Invalidate CloudFront cache
        env:
          CF_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "$CF_DISTRIBUTION_ID" \
            --paths "/*"
          # CloudFront 캐시는 지우지만, S3 파일 자체는 삭제하지 않음

  # -----------------------------
  # 3) 배포: 백엔드만 EC2에 반영 (SSM)
  # -----------------------------
  deploy:
    needs: [build-back, build-front]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy backend via SSM (tag-based)
        env:
          TARGET_DIR: ${{ env.TARGET_DIR }}
          GHCR_READ_USER: ${{ secrets.GHCR_READ_USER }}
          GHCR_READ_TOKEN: ${{ secrets.GHCR_READ_TOKEN }}
          IMAGE_TAG: ${{ github.ref_name }}   # 예: v1.2.3
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy sisc-web backend (tag: ${{ github.ref_name }})" \
            --targets "Key=tag:${{ env.EC2_TAG_KEY }},Values=${{ env.EC2_TAG_VALUE }}" \
            --parameters "commands=[
              \"cd ${TARGET_DIR}\",
              \"echo 'BACK_IMAGE_TAG=${IMAGE_TAG}'  > .env.tag\",
              \"export \$(cat .env.tag | xargs)\",
              \"echo '${GHCR_READ_TOKEN}' | docker login ghcr.io -u '${GHCR_READ_USER}' --password-stdin\",
              \"docker compose pull api\",
              \"docker compose up -d --remove-orphans api\"
            ]" \
            --output text
